---
title: "The Titanic Kaggle Challenge"
author: "Chris Bemben"
date: "9/5/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

Details of this Kaggle challenge can be found [here](https://www.kaggle.com/c/titanic), the challenge is to accurately predict whether a passenger survived or not. The response variable is binary (1 or 0) since a passenger cannot partially survive. This document will use the [Stan](https://mc-stan.org/) programming language and logistic regression to attack the challenge.

```{r, echo=FALSE, message=FALSE}
library(rstan)
library(rstanarm)
library(magrittr)

train <- read.csv(file = '~/projectrepos/titanic/data/train.csv')
test <- read.csv(file = '~/projectrepos/titanic/data/test.csv')

str(train)
```

It's a common anecdote that women and children were the first passengers saved so the first model will only use age and gender as predictors. Since there is a substantial number of missing age values, nulls will be imputed, see this `Exploratory Data Analysis` vignette for the details of the imputation methodology.

```{r, message=FALSE, warning=FALSE}
table(is.na(train$Age))
train$Age[is.na(train$Age)] <- with(train, 
                                    ave(Age, Embarked, Pclass, 
                                        FUN = function(x) 
                                          median(x, na.rm = TRUE)))
table(is.na(test$Age))
test$Age[is.na(test$Age)] <- with(test, 
                                    ave(Age, Embarked, Pclass, 
                                        FUN = function(x) 
                                          median(x, na.rm = TRUE)))
```

Now generate some sample data

```{r, results='hide', message=FALSE}
simple_model <- stan_model('~/projectrepos/titanic/stan/mod001.stan')
```

```{r}
simple_fit <- sampling(
  simple_model,
  data = list(N=nrow(train), y=train$Age),
  cores = 4,
  seed = 123
)
```

```{r}
print(simple_fit, pars=c('mu','sigma'))
```

```{r, message=FALSE}
library(bayesplot)
samp <- rstan::extract(simple_fit)

hist(samp$y_rep, freq=FALSE)
```

## Fit Logistic Regression

Age is only explanatory variable at this time.

```{r, results="hide", message=FALSE}
age_logit_mod <- stan_model(file = '~/projectrepos/titanic/stan/mod002-logit.stan')
```

```{r}
age_logit_fit <- sampling(
  age_logit_mod,
  data = list( N = nrow(train), 
               x = train$Age, 
               y = train$Survived, 
               N_new = nrow(test),
               cores = 4,
               x_new=test$Age),
  seed = 111
)
```

```{r}
age_logit_ext <- rstan::extract(age_logit_fit)

par(mfrow = c(3,1))
hist(age_logit_ext$alpha, main = 'alpha param')
hist(age_logit_ext$beta, main = 'beta param')
hist(age_logit_ext$y_rep, main = 'simulated survival')
```

```{r}
posterior <- as.array(age_logit_fit)
bayesplot::mcmc_scatter(posterior, pars=c("alpha","beta"))
```

```{r}
bayesplot::mcmc_intervals(posterior, pars=c("alpha","beta"))
```

```{r, message=FALSE}
#https://discourse.mc-stan.org/t/posterior-prediction-from-logit-regression/12217/2
postDF <- as.data.frame(age_logit_ext$y_new)
bayesplot::ppc_stat(y = as.integer(train$Survived[1:418]), yrep = as.matrix(postDF), stat = mean)
```

```{r, message=FALSE}
bayesplot::ppc_stat_grouped(y = as.integer(train$Survived[1:418]), yrep = as.matrix(postDF), stat = mean, group = train$Pclass[1:418])
```
The passenger class shows heterogeneitiy across passenger class. However, the model assumes the same suvivial rate across classes.

```{r, results="hide", message=FALSE}
age_logit_hier_mod <- stan_model('~/projectrepos/titanic/stan/mod002-logit-hier.stan')
```

```{r}
age_logit_hier_fit <- sampling(
              age_logit_hier_mod,
              data = list( N = nrow(train),
                           age = train$Age,
                           Pclass = 3,
                           pclass_idx = train$Pclass,
                           survival = train$Survived ),
              seed = 112,
              cores = 4)
```

The survival rate is similar to the actual data.

```{r}
print(age_logit_hier_fit, pars = c('alpha','beta'))
```

```{r}
age_logit_hier_ext <- rstan::extract(age_logit_hier_fit)
y_rep <- as.matrix(age_logit_hier_fit, pars = "y_rep")

ppc_stat_grouped(age_logit_hier_ext,
                 y = train$Survived,
                 yrep = y_rep[1:891,],
                 group = train$Pclass,
                 stat = "mean",
                 binwidth = 0.009)

```

Predict with new data
```{r}

beta_post <- age_logit_hier_ext$beta

# Function for simulating y based on new x
gen_quant_r <- function(age, Pclass) {
  alpha_post<- age_logit_hier_ext$alpha[,Pclass] #get intercept for class of passenger
  lin_comb <- sample(alpha_post, size = length(age)) + age*sample(beta_post, size = length(age))
  prob <- 1/(1 + exp(-lin_comb)) #inverse of logit link function
  out <- rbinom(length(age), 1, prob)
  return(out)
}

y_hat_tr <- gen_quant_r(train$Age, test$Pclass)
mean(y_hat_tr == train$Survived)
```

generate predictions on the test data
```{r}
#y_hat <- gen_quant_r(test$Age, test$Pclass)

# Accuracy
#pred_df <- data.frame(PassengerId = test$PassengerId, Survived=y_hat)
#write.csv(pred_df, file = "~/projectrepos/titanic/data/predict_20200918.csv", row.names = F)
```



## Appendix: Full Stan Programs

`mod001.stan`
```{r, engine='bash', echo=FALSE}
cat ~/projectrepos/titanic/stan/mod001.stan
```

`mod002-logit.stan`
```{r, engine='bash', echo=FALSE}
cat ~/projectrepos/titanic/stan/mod002-logit.stan
```

`mod002-logit-hier.stan`
```{r, engine='bash', echo=FALSE}
cat ~/projectrepos/titanic/stan/mod002-logit-hier.stan
```
