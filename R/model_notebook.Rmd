---
title: "models"
author: "Chris Bemben"
date: "9/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r cars}
library(rstan)
library(rstanarm)
library(magrittr)

simple_model <- stan_model('~/projectrepos/titanic/stan/mod001.stan')
print(simple_model)
```

Now generate some sample data

```{r pressure}
simple_fit <- sampling(
  simple_model,
  data = list(N=nrow(train), y=train$Age),
  #chains = 1,
  #iter =1000,
  #algorithm = 'NUTS',
  seed = 123
)
```

```{r}
summary(simple_fit)
```

```{r}
library(bayesplot)
samp <- rstan::extract(simple_fit)

hist(samp$y_rep, freq=FALSE)
```

## Fit Logistic Regression

Age is only explanatory variable at this time.

```{r}
age_logit_mod <- stan_model(file = '~/projectrepos/titanic/stan/mod002-logit.stan')

age_logit_fit <- sampling(
  age_logit_mod,
  data = list( N = nrow(train), 
               x = train$Age, 
               y = train$Survived, 
               N_new = nrow(test), 
               x_new=test$Age),
  seed = 111
)
```

```{r}
age_logit_ext <- extract(age_logit_fit)

par(mfrow = c(3,1))
hist(age_logit_ext$alpha, main = 'alpha param')
hist(age_logit_ext$beta, main = 'beta param')
hist(age_logit_ext$y_rep, main = 'simulated survival')
```

```{r}
posterior <- as.array(age_logit_fit)
bayesplot::mcmc_scatter(posterior, pars=c("alpha","beta"))
```

```{r}
bayesplot::mcmc_intervals(posterior, pars=c("alpha","beta"))
```

```{r}
#https://discourse.mc-stan.org/t/posterior-prediction-from-logit-regression/12217/2
postDF <- as.data.frame(age_logit_ext$y_new)
bayesplot::ppc_stat(y = as.integer(train$Survived[1:418]), yrep = as.matrix(postDF), stat = mean)
```


```{r}
age_logit_hier_mod <- stan_model('~/projectrepos/titanic/stan/mod002-logit-hier.stan')
age_logit_hier_fit <- sampling(
              age_logit_hier_mod,
              data = list( N = nrow(train), 
                           Pclass = nlevels(factor(train$Pclass)),
                           gIndex = train$Pclass,
                           age = train$Age, 
                           survival = train$Survived ),
  seed = 112)
```

The survival rate is similar to the actual data.

```{r}
age_logit_hier_ext <- extract(age_logit_hier_fit, pars="y_rep")

age_logit_hier_fit %>% 
posterior_predict( draws=500) %>% 
ppc_stat_grouped(y = sum(train$Survived),
                 group = train$Pclass,
                 stat = "median")

```